# Skeleton Chi Blog

Work in Progress. 

Unlike Django & Rails, [`chi`](https://go-chi.io/#/) does not enforce
structure. This is an attempt to layout such a structure. 


## Directory Layout
```
models/
views/
services/
app/
config/
middleware/
    auth.go
templates/
public/
main.go =>  main() & init()
Makefile =>  run app, run tests, 

# generated by Makefile
_build/
```

Convenient One(ish)-Liner:
```sh
touch main.go
mkdir -p {views,services,models,app,config,middleware,templates,public}
```


## Libraries to use

+ [`logrus`](https://github.com/sirupsen/logrus)
+ [`gorm`](https://gorm.io)
+ [`chi`](https://go-chi.io/#/)

```sh
# as a shell command
go get -u github.com/go-chi/chi/v5 gorm.io/gorm github.com/sirupsen/logrus github.com/go-chi/cors gorm.io/driver/sqlite
```


## Conventions

### `init()`

+ Initializes logging
+ Runs Gorm migrations


### `main()`

Pulls the app (`app/`) and starts the http listener. 

Optional flag is used to start docgen. [See here for an
example](https://github.com/go-chi/chi/blob/master/_examples/rest/main.go#L99). 


### Views

HandlerFuncs should always be lowercased (i.e. "private") with the 
first word being the method (e.g. "POST", "GET", "PUT", etc). 

Template names should be prefixed by the dominant model if there is one. 
E.g. `post_detail.html.tmpl`, `post_list.html.tmpl`, 
`post_new.html.tmpl`, etc. 


### Database management

Optimization is the root of all bugs. That means `gorm` is leveraged without 
any functions on top (e.g. no `GetPostByUuid(...)`). In the future, you'd 
probably remove this so as to leverage raw SQL queries. 


### Testing

Write utility functions! Type enforcement becomes annoying with golang. 

POST/PUT/PATCH requests will all need a `Content-Type: application/x-www-form-urlencoded`
added to the header. 

It's not worth testing every folder. One of the folders that really 
doesn't matter is `/templates`. 

Functions _should_ do one thing and with little to no side effects. This
makes it easy to follow logic around. _Tests are an exception!_ They can 
test multiple functions at once. This is allowed because it more closely
resembles how your program works. It also allowed for daisy chaining 
how functions can work (e.g. you create and then query, which might be
testing two separate operations). In practice, your tests should run 
entirely correctly or not at all so any breaking functionality will break 
_a test_ somewhere that you can then diagnose and fix. 


### Linting

Two linters are used: `staticcheck` and `golangci-lint`. Both are given stock configurations but can be configured to taste. 

The list of available checks for `staticcheck` are listed [here](https://staticcheck.dev/docs/checks/). 

The list of available checks for `golangci-lint` are listed [here](https://golangci-lint.run/usage/quick-start/). Unlike `staticcheck`, it is _not_ [installed by default](https://golangci-lint.run/usage/install/) via the `make install`. 


### Middleware Order

_Very_ WIP

1. [`Profiler`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#Profiler)
1. [`Logger`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#Logger) -- though [maybe this?](https://github.com/chi-middleware/logrus-logger)
2. [`Compress`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#Compress)
3. [`cors`](https://github.com/go-chi/cors)
4. [`CleanPath`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#CleanPath)
5. [`StripSlashes`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#StripSlashes)
6. [`RealIP`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#RealIP)
7. [`gorilla/sessions`](https://github.com/gorilla/sessions)


#### Sessions Middleware

If using encryption, encryption keys need to be exactly 16, 24, or 32. Authentication keys can be any length. 



### Model-View-Controller (MVC)

Views (`views/`) take in the request, pass all business logic to the
controller (`services/`) which can use models (`models/`) to persist
and modify the underlying data. They then return to the view, which
populates a template (`templates/`) -- or not -- and returns a
response. 

Views _never handle business logic_. That is _solely_ the job of a
service. This makes it easier to not only debug but also build because 
we can "stub" out the business logic when making sure the view logic
looks correct.

The solely exception to above are value for templating. This includes the 
count of a list of posts submitted. 


## Things to Do

+ **Turn into a cookiecutter project**
  + [ ] look for variables that need to be replaced

+ [ ] [yasnippets](http://joaotavora.github.io/yasnippet/) to create
      Golang things
  + [ ] generic file starting with package
  + [ ] generic test
  + [ ] generic file one-file with main/init
  + [ ] generic test w/stretchr
  + [ ] generic test for a route (no content)
  + [ ] template variable via go:embed
  + [ ] compiled template
  + [ ] generic route with template pull and compiling, executed against anonymous struct
  + [ ] `sort.Slice` (no idea what I meant here)
  + [ ] extracting a cookie
  + [ ] extract html via `goquery`
  + [ ] iterating over resp cookies and adding them to a further request
  + [ ] full request-response-checkbody 
  + [ ] generic handler via `func(w http.ResponseWriter, r *http.Request) { })`

  
### Completed

+ [X] write test for `services.UpdatePostByUuid` 
+ [x] replace all view tests with go-query
+ [x] write test for `/posts/\<uuid\>` for editing (POST, GET)
+ [x] add `/logout`
+ [x] make cookie store crypto key an environmental variable
+ [x] [Custom 404 & 405 handlers](https://go-chi.io/#/pages/routing?id=making-custom-404-and-405-handlers) -- see docs in go-chi 
+ [x] [Add HTMX middleware](https://pkg.go.dev/github.com/mavolin/go-htmx) 
+ [x] Add [`middleware.Timeout`](https://pkg.go.dev/github.com/go-chi/chi/v5/middleware#Timeout)  at the very end of the middleware stack, make the exact set by a flag
+ [x] Static file serving via http.FileServer -- [Implementation example](https://gist.github.com/bmcculley/055518d703899ec3a91f7aae732b04d2), [accompanying blog post](https://hakk.dev/blog/posts/go-embed-example/) 
+ [x] CLI flag to do migrations
+ [x] rewrite `executeRequest` to accept an optional list of cookie headers via [arrays](https://stackoverflow.com/a/23724092) and [variadic arguments](https://blog.learngoprogramming.com/golang-variadic-funcs-how-to-patterns-369408f19085)
+ [x] add net profiler to middleware stack as togglable flag
+ [x] expand build to create linux/amd64 builds
+ [x] refactor getting data out of formData for services -- return first value, handle printing errors in trying to get non-existent keys


### Down the Road

+ [ ] [Very Simple Binary deploy with Traefik](https://stackoverflow.com/questions/58496270/traefik-v2-as-a-reverse-proxy-without-docker) or leveraging [Nginx/certbot combo](https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/)
+ [ ] Various JS setups
  + [ ] [Tailwind CSS setup](https://tailwindcss.com/docs/installation) (via NPM) -- possibly as a cookiecutter flag?
  + [ ] [AlpineJS](https://alpinejs.dev)
  + [ ] [HTMX](https://htmx.org)
+ [ ] Support for non-SQLite databases via CLI
+ [ ] add hCaptcha support =>  [Stop bots and human abuse.](https://www.hcaptcha.com/), possibly with cookiecutter flag?
+ [ ] add [Swagger support](https://github.com/swaggo/http-swagger)


#### Very very down the road

Much less interest on my part with this

+ [ ] Support for MongoDB via CLI
+ [ ] Add HTMX and Hyperscript (download as a post hook, shutil and urllib3 in Python) 
+ [ ] [add simple asynq task queues](https://github.com/hibiken/asynq) 
+ [ ] Add raw SQL query support -- getting stringified responses is kind of difficult



## Errata Notes

+ Write tests for models as examples of what to do, don't bother with special functions to do specific work because you don't know the domain space yet

+ using names to make sure that pieces don't get accessed outside of where they should (app.session)

+ do you test that auth works or not? _Only for end-to-end_. Because services are separated from routes, this means you can test business logic separately. A helper function should be written for making the authentication process simple. 
